<div class="top_page">
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <%= link_to '野菜登録する', 'add_vegetables',:style=>"color:#ffffff;" %>
      </li>
    </ul>

  </div>
  <canvas id="myChart" width="400" height="400"></canvas>
  <hr>

  <% @dishes.each do |dish| %>
  <div class="checkbox-inline">
    <div>
      <%= check_box 'dish', '1', {:onchange => 'check_changed()'}, true, false %>
        <h3 class="recipe_title"
            style="background-image:url('<%= dish.img_url %>')">
          <a href="http://recipe.rakuten.co.jp/recipe/<%= dish.recipe_id %>/"><%= dish.recipe_title %></a>
          (<%= dish.serving %>人分)
        </h3>
    </div>
  </div>
  <table class="table">
  <% @vegetable_stocks.to_a.each do |vegetable_stock| %>
    <% if (veg_count = dish.send(vegetable_stock[0])) != 0 then %>
    <tr data-<%= vegetable_stock[0] %>="<%= veg_count %>"><!-- data-carrot="0.25" のような形式で野菜の数データに持つ -->
      <td><%= image_tag('veg_' + vegetable_stock[0].to_s + '.png', :size => '32x32') %></td>
      <td><%= vegetable_stock[1] %></td>
      <td><%= veg_count %> 個</td>
    </tr>
    <% end %>
  <% end %>
  </table>
  <hr>
<% end %>

<script>
var ctx = document.getElementById("myChart");
var ctx = document.getElementById("myChart").getContext("2d");
var ctx = $("#myChart");

var veg_list = new Array();//野菜の英語名
var label_list = new Array();//野菜の名前（日本語）
var data_list = new Array();//手持ちの野菜

//手持ちの野菜
for (var i = 0; i < gon.vegetable_stocks.length; i ++) {
  var vegetable_stock = gon.vegetable_stocks[i];
  veg_list.push(vegetable_stock[0])
  label_list.push(vegetable_stock[1]);
  data_list.push(vegetable_stock[2]);
}

//使う予定の野菜
var will_list = get_will_list();

var myChart = new Chart(ctx, {
    type: 'radar',
    data: {
        labels: label_list,
        datasets: [{
            label: '手持ちの野菜',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255,99,132,1)',
            borderWidth: 1,
            data: data_list,
        },
                   {
            label: '使う予定の野菜',
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1,
            data: will_list,
        }
        ]
    },
    options: { 
      scale: {
                ticks: {
                    suggestedMax: 5
                }
            }
    }
});

function check_changed() {
  var will_list = get_will_list();
  myChart.data.datasets[1].data = will_list;
  myChart.update();

  check_celebrate();
}

function get_will_list() {
  var will_list = new Array();
  for (var j = 0; j < veg_list.length; j++) {
    var vegs = document.querySelectorAll('[data-' + veg_list[j] + ']');
    var veg_count = 0;
    for (var i = 0; i < vegs.length; i++) {
      var veg = vegs[i];
      var checkbox = veg.parentNode.parentNode.previousElementSibling.firstElementChild.firstElementChild;
      if (checkbox.checked) {
        veg_count += parseFloat(veg.dataset[veg_list[j]]);
      }
    }
    will_list.push(veg_count);
  }
  return will_list;
}

function check_celebrate() {
  var match_count = 0; // 一致した数
  var miss_match = false // 不一致
  for (var i = 0; i < veg_list.length; i++) {
    var current_veg_count = myChart.data.datasets[0].data[i];
    var will_veg_count = myChart.data.datasets[1].data[i];
    if (will_veg_count == current_veg_count) {
      if (will_veg_count != 0) {
        match_count ++;
      }
    } else {
      miss_match = true;
    }
  }
  // 暫定表示
  if (!miss_match && 0 < match_count) {
    window.scroll(0,0);
    setTimeout(function(){
      alert(match_count + "個の野菜が一致しました！");
    },500);
  }
}

</script>
  <!-- /container -->
